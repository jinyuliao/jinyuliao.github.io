<?xml version="1.0" encoding="utf-8"?>
<rss version="2.0">
    <channel>
        <title>Jinyu Liao's Blog</title>
        <link>https://jinyuliao.github.io/blog/html/</link>
        <description></description>
        <language>en-us</language>
        <pubDate>Fri, 15 Dec 2017 00:00:00 +0800</pubDate>
        
        <item>
            <link>https://jinyuliao.github.io/blog/html/2017/12/15/ue4_dialogue_system_part2.html</link>
            <guid>https://jinyuliao.github.io/blog/html/2017/12/15/ue4_dialogue_system_part2.html</guid>
            <title><![CDATA[UE4 Dialogue System Part2]]></title>
            <description><![CDATA[<h1>UE4 Dialogue System Part2</h1>
<p><a class="reference external" href="https://jinyuliao.github.io/blog/html/2017/12/15/ue4_dialogue_system_part1.html">Part1</a></p>
<p>In this part, we will create a new asset type: <strong>DialogueSession</strong>.</p>
<div class="section" id="step-1">
<h2>Step 1</h2>
<ul class="simple">
<li>Create header files: “DialogueSession.h”, “DialogueSessionNode.h”, “DialogueSessionEdge.h” in your {ProjectRoot}/Source/{ProjectName}/Public folder</li>
<li>Create source files: “DialogueSession.cpp”, “DialogueSessionNode.cpp” in your {ProjectRoot}/Source/{ProjectName}/Private folder</li>
<li>Regenerate solution file</li>
<li>Open solution file</li>
</ul>
<p>now your solution should looks like this:</p>
<img alt="../../../_images/sln_with_dialogue_session.png" src="https://jinyuliao.github.io/blog/html/_images/sln_with_dialogue_session.png"/>
</div>
<div class="section" id="step-2">
<h2>Step 2</h2>
<p>Edit {YourProject}.Build.cs, add a dependency: <strong>GenericGraphRuntime</strong></p>
<div class="highlight-c#"><div class="highlight"><pre><span/><span class="n">PrivateDependencyModuleNames</span><span class="p">.</span><span class="n">AddRange</span><span class="p">(</span><span class="k">new</span> <span class="kt">string</span><span class="p">[]</span> <span class="p">{</span> <span class="s">"GenericGraphRuntime"</span> <span class="p">});</span>
</pre></div>
</div>
</div>
<div class="section" id="step-3">
<h2>Step 3</h2>
<p>Implement class: UDialogueSessionNode</p>
<p>DialogueSessionNode.h</p>
<div class="highlight-c++"><div class="highlight"><pre><span/><span class="cp">#pragma once</span>

<span class="cp">#pragma once</span>

<span class="cp">#include</span> <span class="cpf">"CoreMinimal.h"</span><span class="cp"/>
<span class="cp">#include</span> <span class="cpf">"GenericGraphNode.h"</span><span class="cp"/>
<span class="cp">#include</span> <span class="cpf">"DialogueSessionNode.generated.h"</span><span class="cp"/>

<span class="n">UENUM</span><span class="p">(</span><span class="n">BlueprintType</span><span class="p">)</span>
<span class="k">enum</span> <span class="k">class</span> <span class="nc">EDialoguerPostion</span> <span class="o">:</span> <span class="n">uint8</span>
<span class="p">{</span>
    <span class="n">Left</span><span class="p">,</span>
    <span class="n">Right</span>
<span class="p">};</span>

<span class="n">UCLASS</span><span class="p">(</span><span class="n">Blueprintable</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">UDialogueSessionNode</span> <span class="o">:</span> <span class="k">public</span> <span class="n">UGenericGraphNode</span>
<span class="p">{</span>
    <span class="n">GENERATED_BODY</span><span class="p">()</span>
<span class="k">public</span><span class="o">:</span>
    <span class="n">UDialogueSessionNode</span><span class="p">();</span>

    <span class="n">UPROPERTY</span><span class="p">(</span><span class="n">EditDefaultsOnly</span><span class="p">,</span> <span class="n">BlueprintReadOnly</span><span class="p">,</span> <span class="n">Category</span> <span class="o">=</span> <span class="s">"DialogueSession"</span><span class="p">)</span>
    <span class="n">FText</span> <span class="n">Paragraph</span><span class="p">;</span>

    <span class="n">UPROPERTY</span><span class="p">(</span><span class="n">EditDefaultsOnly</span><span class="p">,</span> <span class="n">BlueprintReadOnly</span><span class="p">,</span> <span class="n">Category</span> <span class="o">=</span> <span class="s">"DialogueSession"</span><span class="p">)</span>
    <span class="n">EDialoguerPostion</span> <span class="n">DialoguerPostion</span><span class="p">;</span>

<span class="cp">#if WITH_EDITOR</span>
    <span class="k">virtual</span> <span class="n">FText</span> <span class="nf">GetNodeTitle</span><span class="p">()</span> <span class="k">const</span> <span class="k">override</span><span class="p">;</span>

    <span class="k">virtual</span> <span class="kt">void</span> <span class="nf">SetNodeTitle</span><span class="p">(</span><span class="k">const</span> <span class="n">FText</span><span class="o">&amp;</span> <span class="n">NewTitle</span><span class="p">)</span> <span class="k">override</span><span class="p">;</span>

    <span class="k">virtual</span> <span class="n">FLinearColor</span> <span class="nf">GetBackgroundColor</span><span class="p">()</span> <span class="k">const</span> <span class="k">override</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="p">};</span>
</pre></div>
</div>
<p>DialogueSessionNode.cpp</p>
<div class="highlight-c++"><div class="highlight"><pre><span/><span class="cp">#include</span> <span class="cpf">"DialogueSessionNode.h"</span><span class="cp"/>
<span class="cp">#include</span> <span class="cpf">"DialogueSession.h"</span><span class="cp"/>

<span class="cp">#define LOCTEXT_NAMESPACE "DialogueSessionNode"</span>

<span class="n">UDialogueSessionNode</span><span class="o">::</span><span class="n">UDialogueSessionNode</span><span class="p">()</span>
<span class="p">{</span>
<span class="cp">#if WITH_EDITORONLY_DATA</span>
    <span class="n">CompatibleGraphType</span> <span class="o">=</span> <span class="n">UDialogueSession</span><span class="o">::</span><span class="n">StaticClass</span><span class="p">();</span>

    <span class="n">ContextMenuName</span> <span class="o">=</span> <span class="n">LOCTEXT</span><span class="p">(</span><span class="s">"ConextMenuName"</span><span class="p">,</span> <span class="s">"Dialogue Session Node"</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="cp">#if WITH_EDITOR</span>

<span class="n">FText</span> <span class="n">UDialogueSessionNode</span><span class="o">::</span><span class="n">GetNodeTitle</span><span class="p">()</span> <span class="k">const</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="n">Paragraph</span><span class="p">.</span><span class="n">IsEmpty</span><span class="p">()</span> <span class="o">?</span> <span class="n">LOCTEXT</span><span class="p">(</span><span class="s">"EmptyParagraph"</span><span class="p">,</span> <span class="s">"(Empty paragraph)"</span><span class="p">)</span> <span class="o">:</span> <span class="n">Paragraph</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">UDialogueSessionNode</span><span class="o">::</span><span class="n">SetNodeTitle</span><span class="p">(</span><span class="k">const</span> <span class="n">FText</span><span class="o">&amp;</span> <span class="n">NewTitle</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">Paragraph</span> <span class="o">=</span> <span class="n">NewTitle</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">FLinearColor</span> <span class="n">UDialogueSessionNode</span><span class="o">::</span><span class="n">GetBackgroundColor</span><span class="p">()</span> <span class="k">const</span>
<span class="p">{</span>
    <span class="n">UDialogueSession</span><span class="o">*</span> <span class="n">Graph</span> <span class="o">=</span> <span class="n">Cast</span><span class="o">&lt;</span><span class="n">UDialogueSession</span><span class="o">&gt;</span><span class="p">(</span><span class="n">GetGraph</span><span class="p">());</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">Graph</span> <span class="o">==</span> <span class="k">nullptr</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Super</span><span class="o">::</span><span class="n">GetBackgroundColor</span><span class="p">();</span>

    <span class="k">switch</span> <span class="p">(</span><span class="n">DialoguerPostion</span><span class="p">)</span>
    <span class="p">{</span>
    <span class="k">case</span> <span class="n">EDialoguerPostion</span><span class="o">::</span><span class="nl">Left</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">Graph</span><span class="o">-&gt;</span><span class="n">LeftDialoguerBgColor</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">EDialoguerPostion</span><span class="o">::</span><span class="nl">Right</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">Graph</span><span class="o">-&gt;</span><span class="n">RightDialoguerBgColor</span><span class="p">;</span>
    <span class="k">default</span><span class="o">:</span>
        <span class="k">return</span> <span class="n">FLinearColor</span><span class="o">::</span><span class="n">Black</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="cp">#endif</span>

<span class="cp">#undef LOCTEXT_NAMESPACE</span>
</pre></div>
</div>
<p>We extended the <em>UGenericGraphNode</em>, added two properties to the node:</p>
<ul class="simple">
<li><em>Paragraph</em>: the dialogue content</li>
<li><em>DialoguerPostion</em>: indicate the dialoguer’s position(left or right).</li>
</ul>
<p>Override the <em>GetNodeTitle</em> and <em>SetNodeTitle</em> method to use the Paragraph property as the node title.</p>
<p>Override the <em>GetBackgroundColor</em> method, change the node’s background color by dialoguer’s position</p>
</div>
<div class="section" id="step-4">
<h2>Step 4</h2>
<p>Implement class: UDialogueSessionEdge</p>
<p>DialogueSessionEdge.h</p>
<div class="highlight-c++"><div class="highlight"><pre><span/><span class="cp">#pragma once</span>

<span class="cp">#include</span> <span class="cpf">"CoreMinimal.h"</span><span class="cp"/>
<span class="cp">#include</span> <span class="cpf">"GenericGraphEdge.h"</span><span class="cp"/>
<span class="cp">#include</span> <span class="cpf">"DialogueSessionEdge.generated.h"</span><span class="cp"/>


<span class="n">UCLASS</span><span class="p">(</span><span class="n">Blueprintable</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">UDialogueSessionEdge</span><span class="o">:</span> <span class="k">public</span> <span class="n">UGenericGraphEdge</span>
<span class="p">{</span>
    <span class="n">GENERATED_BODY</span><span class="p">()</span>

<span class="k">public</span><span class="o">:</span>
    <span class="n">UPROPERTY</span><span class="p">(</span><span class="n">EditDefaultsOnly</span><span class="p">,</span> <span class="n">BlueprintReadOnly</span><span class="p">,</span> <span class="n">Category</span> <span class="o">=</span> <span class="s">"DialogueSession"</span><span class="p">)</span>
    <span class="n">FText</span> <span class="n">Selection</span><span class="p">;</span>
<span class="p">};</span>
</pre></div>
</div>
<p>We extended the <em>UDialogueSessionEdge</em>, added a <em>Selection</em> property, this will be used to implment dialogue branch.</p>
</div>
<div class="section" id="step-5">
<h2>Step 5</h2>
<p>Implement class: UDialogueSession</p>
<p>DialogueSession.h:</p>
<div class="highlight-c++"><div class="highlight"><pre><span/><span class="cp">#pragma once</span>

<span class="cp">#include</span> <span class="cpf">"CoreMinimal.h"</span><span class="cp"/>
<span class="cp">#include</span> <span class="cpf">"GenericGraph.h"</span><span class="cp"/>
<span class="cp">#include</span> <span class="cpf">"DialogueSession.generated.h"</span><span class="cp"/>

<span class="n">UCLASS</span><span class="p">(</span><span class="n">Blueprintable</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">DIALOGUESYSTEM_API</span> <span class="nl">UDialogueSession</span><span class="p">:</span> <span class="k">public</span> <span class="n">UGenericGraph</span>
<span class="p">{</span>
    <span class="n">GENERATED_BODY</span><span class="p">()</span>

<span class="k">public</span><span class="o">:</span>
    <span class="n">UDialogueSession</span><span class="p">();</span>

    <span class="n">UPROPERTY</span><span class="p">(</span><span class="n">EditDefaultsOnly</span><span class="p">,</span> <span class="n">Category</span> <span class="o">=</span> <span class="s">"DialogueSession"</span><span class="p">)</span>
    <span class="n">FLinearColor</span> <span class="n">LeftDialoguerBgColor</span><span class="p">;</span>

    <span class="n">UPROPERTY</span><span class="p">(</span><span class="n">EditDefaultsOnly</span><span class="p">,</span> <span class="n">Category</span> <span class="o">=</span> <span class="s">"DialogueSession"</span><span class="p">)</span>
    <span class="n">FLinearColor</span> <span class="n">RightDialoguerBgColor</span><span class="p">;</span>
<span class="p">};</span>
</pre></div>
</div>
<p>DialogueSession.cpp</p>
<div class="highlight-c++"><div class="highlight"><pre><span/><span class="cp">#include</span> <span class="cpf">"DialogueSession.h"</span><span class="cp"/>
<span class="cp">#include</span> <span class="cpf">"DialogueSessionNode.h"</span><span class="cp"/>
<span class="cp">#include</span> <span class="cpf">"DialogueSessionEdge.h"</span><span class="cp"/>

<span class="cp">#define LOCTEXT_NAMESPACE "DialogueSession"</span>

<span class="n">UDialogueSession</span><span class="o">::</span><span class="n">UDialogueSession</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">NodeType</span> <span class="o">=</span> <span class="n">UDialogueSessionNode</span><span class="o">::</span><span class="n">StaticClass</span><span class="p">();</span>
    <span class="n">EdgeType</span> <span class="o">=</span> <span class="n">UDialogueSessionEdge</span><span class="o">::</span><span class="n">StaticClass</span><span class="p">();</span>

    <span class="n">LeftDialoguerBgColor</span> <span class="o">=</span> <span class="n">FLinearColor</span><span class="o">::</span><span class="n">Black</span><span class="p">;</span>
    <span class="n">RightDialoguerBgColor</span> <span class="o">=</span> <span class="n">FLinearColor</span><span class="p">(</span><span class="mf">0.93f</span><span class="p">,</span> <span class="mf">0.93f</span><span class="p">,</span> <span class="mf">0.93f</span><span class="p">,</span> <span class="mf">1.f</span><span class="p">);</span>

    <span class="n">Name</span> <span class="o">=</span> <span class="s">"DialogueSession"</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#undef LOCTEXT_NAMESPACE</span>
</pre></div>
</div>
<p>We created a class <em>UDialogueSession</em> which inherit from <em>UGenericGraph</em>, this class will be the new asset type.</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">DIALOGUESYSTEM_API should changed to {YOURPROJECT}_API.</p>
</div>
</div>
<div class="section" id="step-6">
<h2>Step 6</h2>
<p>We need to create an asset factory which inherit from <em>UFactory</em>, but this class can’t add to your game project directly, because <em>UFactory</em> are in the module <strong>UnrealEd</strong>, this is an editor module,
you can’t pass the Shipping build if your game depends on any editor module.</p>
<p>Solution: creating an editor module for your game project, here is an <a class="reference external" href="https://wiki.unrealengine.com/Creating_an_Editor_Module">tutorial</a>.</p>
<p>After created an editor module, creating “DialogueSessionFactory.h” and “DialogueSessionFactory.cpp” in {YourProject}/Source/{YourProjectEditor}/Private and regenerate solution file.</p>
<p>Your solution should looks like this now:</p>
<img alt="../../../_images/sln_with_editor.png" src="https://jinyuliao.github.io/blog/html/_images/sln_with_editor.png"/>
</div>
<div class="section" id="step-7">
<h2>Step 7</h2>
<p>Edit the {YourProjectEditor}.Build.cs, add dependency module: <em>UnrealEd</em>, <em>GenericGraphRuntime</em>, <em>{YourGameProject}</em> and include path: <em>{YourGameProject}/Public</em></p>
<div class="highlight-c#"><div class="highlight"><pre><span/><span class="n">PublicIncludePaths</span><span class="p">.</span><span class="n">AddRange</span><span class="p">(</span><span class="k">new</span> <span class="kt">string</span><span class="p">[]{</span><span class="s">"DialogueSystem/Public"</span><span class="p">});</span>

<span class="n">PrivateDependencyModuleNames</span><span class="p">.</span><span class="n">AddRange</span><span class="p">(</span><span class="k">new</span> <span class="kt">string</span><span class="p">[]</span> <span class="p">{</span> <span class="s">"UnrealEd"</span><span class="p">,</span> <span class="s">"GenericGraphRuntime"</span><span class="p">,</span> <span class="s">"DialogueSystem"</span> <span class="p">});</span>
</pre></div>
</div>
</div>
<div class="section" id="step-8">
<h2>Step 8</h2>
<p>Implement DialogueSessionFactory</p>
<p>DialogueSessionFactory.h</p>
<div class="highlight-c++"><div class="highlight"><pre><span/><span class="cp">#pragma once</span>

<span class="cp">#include</span> <span class="cpf">"CoreMinimal.h"</span><span class="cp"/>
<span class="cp">#include</span> <span class="cpf">"Factories/Factory.h"</span><span class="cp"/>
<span class="cp">#include</span> <span class="cpf">"DialogueSessionFactory.generated.h"</span><span class="cp"/>

<span class="n">UCLASS</span><span class="p">()</span>
<span class="k">class</span> <span class="nc">UDialogueSessionFactory</span> <span class="o">:</span> <span class="k">public</span> <span class="n">UFactory</span>
<span class="p">{</span>
    <span class="n">GENERATED_BODY</span><span class="p">()</span>

<span class="k">public</span><span class="o">:</span>
    <span class="n">UDialogueSessionFactory</span><span class="p">();</span>

    <span class="k">virtual</span> <span class="n">UObject</span><span class="o">*</span> <span class="nf">FactoryCreateNew</span><span class="p">(</span><span class="n">UClass</span><span class="o">*</span> <span class="n">Class</span><span class="p">,</span> <span class="n">UObject</span><span class="o">*</span> <span class="n">InParent</span><span class="p">,</span> <span class="n">FName</span> <span class="n">Name</span><span class="p">,</span> <span class="n">EObjectFlags</span> <span class="n">Flags</span><span class="p">,</span> <span class="n">UObject</span><span class="o">*</span> <span class="n">Context</span><span class="p">,</span> <span class="n">FFeedbackContext</span><span class="o">*</span> <span class="n">Warn</span><span class="p">)</span> <span class="k">override</span><span class="p">;</span>
    <span class="k">virtual</span> <span class="n">FText</span> <span class="nf">GetDisplayName</span><span class="p">()</span> <span class="k">const</span> <span class="k">override</span><span class="p">;</span>
    <span class="k">virtual</span> <span class="n">FString</span> <span class="nf">GetDefaultNewAssetName</span><span class="p">()</span> <span class="k">const</span> <span class="k">override</span><span class="p">;</span>
<span class="p">};</span>
</pre></div>
</div>
<p>DialogueSessionFactory.cpp</p>
<div class="highlight-c++"><div class="highlight"><pre><span/><span class="cp">#include</span> <span class="cpf">"DialogueSessionFactory.h"</span><span class="cp"/>
<span class="cp">#include</span> <span class="cpf">"DialogueSession.h"</span><span class="cp"/>

<span class="cp">#define LOCTEXT_NAMESPACE "DialogueSessionFactory"</span>

<span class="n">UDialogueSessionFactory</span><span class="o">::</span><span class="n">UDialogueSessionFactory</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">bCreateNew</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
    <span class="n">bEditAfterNew</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
    <span class="n">SupportedClass</span> <span class="o">=</span> <span class="n">UDialogueSession</span><span class="o">::</span><span class="n">StaticClass</span><span class="p">();</span>
<span class="p">}</span>

<span class="n">UObject</span><span class="o">*</span> <span class="n">UDialogueSessionFactory</span><span class="o">::</span><span class="n">FactoryCreateNew</span><span class="p">(</span><span class="n">UClass</span><span class="o">*</span> <span class="n">Class</span><span class="p">,</span> <span class="n">UObject</span><span class="o">*</span> <span class="n">InParent</span><span class="p">,</span> <span class="n">FName</span> <span class="n">Name</span><span class="p">,</span> <span class="n">EObjectFlags</span> <span class="n">Flags</span><span class="p">,</span> <span class="n">UObject</span><span class="o">*</span> <span class="n">Context</span><span class="p">,</span> <span class="n">FFeedbackContext</span><span class="o">*</span> <span class="n">Warn</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="n">NewObject</span><span class="o">&lt;</span><span class="n">UObject</span><span class="o">&gt;</span><span class="p">(</span><span class="n">InParent</span><span class="p">,</span> <span class="n">Class</span><span class="p">,</span> <span class="n">Name</span><span class="p">,</span> <span class="n">Flags</span> <span class="o">|</span> <span class="n">RF_Transactional</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">FText</span> <span class="n">UDialogueSessionFactory</span><span class="o">::</span><span class="n">GetDisplayName</span><span class="p">()</span> <span class="k">const</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="n">LOCTEXT</span><span class="p">(</span><span class="s">"FactoryName"</span><span class="p">,</span> <span class="s">"Dialogue Session"</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">FString</span> <span class="n">UDialogueSessionFactory</span><span class="o">::</span><span class="n">GetDefaultNewAssetName</span><span class="p">()</span> <span class="k">const</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="s">"DialogueSession"</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#undef LOCTEXT_NAMESPACE</span>
</pre></div>
</div>
</div>
<div class="section" id="step-9">
<h2>Step 9</h2>
<p>Compile the solution, open the editor if compile succeeded. right click in your content browser, you can create DialogueSession asset now.</p>
<a class="" data-lightbox="group-31b4a8c6-b75a-4327-a93d-8c81d636ed8f" href="https://jinyuliao.github.io/blog/html/_images/dialogue_session_asset1.png" title="" data-title=""><img src="https://jinyuliao.github.io/blog/html/_images/dialogue_session_asset1.png" class="" width="100%" height="auto" alt=""/>
                </a></div>
<div class="section" id="done">
<h2>Done</h2>
<p>That’s all in this part, you have created a new asset type <a class="footnote-reference" href="#f1" id="id1">[1]</a> <strong>DialogueSession</strong> and extended GenericGraph’s node and edge type.</p>
<p>In the next part, we will dive into blueprint :)</p>
<table class="docutils footnote" frame="void" id="f1" rules="none">
<colgroup><col class="label"/><col/></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id1">[1]</a></td><td>a new graph type with GenericGraph editor</td></tr>
</tbody>
</table>
</div>
]]></description>
            <category><![CDATA[ UE4 Dialogue System ]]></category>
             <pubDate>Fri, 15 Dec 2017 00:00:00 +0800</pubDate>
        </item>
    
        <item>
            <link>https://jinyuliao.github.io/blog/html/2017/12/15/ue4_dialogue_system_part1.html</link>
            <guid>https://jinyuliao.github.io/blog/html/2017/12/15/ue4_dialogue_system_part1.html</guid>
            <title><![CDATA[UE4 Dialogue System Part1]]></title>
            <description><![CDATA[<h1>UE4 Dialogue System Part1</h1>
<div class="section" id="introduction">
<h2>Introduction</h2>
<p>This tutorial create a Fire Emblem-like dialogue system in UE4 with my <a class="reference external" href="https://github.com/jinyuliao/GenericGraph">GenericGraph</a> plugin.</p>
<img alt="https://raw.githubusercontent.com/jinyuliao/GenericGraph/master/docs/images/dialogue/dialogue03.png" src="https://raw.githubusercontent.com/jinyuliao/GenericGraph/master/docs/images/dialogue/dialogue03.png"/>
<p>Prerequisite:</p>
<ul class="simple">
<li>UE4 version: 4.18.2 or higher</li>
<li>C++ development enviroment(Visual Studio on Windows or Xcode on Mac)</li>
<li>Some experience with UE4, can make simple UI with UMG</li>
</ul>
<p>In this part, we wiil create a demo project and compile the plugin.</p>
</div>
<div class="section" id="step-1">
<h2>Step 1</h2>
<p>Create a blueprint project with the TopDown template.</p>
<a class="" data-lightbox="group-b5877bc3-77a2-4eed-abb7-e607f5b54f74" href="https://jinyuliao.github.io/blog/html/_images/create_project1.png" title="" data-title=""><img src="https://jinyuliao.github.io/blog/html/_images/create_project1.png" class="" width="100%" height="auto" alt=""/>
                </a></div>
<div class="section" id="step-2">
<h2>Step 2</h2>
<p>Open your porject’s root folder, create a folder named “<strong>Plugins</strong>”, clone <a class="reference external" href="https://github.com/jinyuliao/GenericGraph">GenericGraph</a> into the “<strong>Plugins</strong>” folder.</p>
<img alt="../../../_images/clone_plugin.png" src="https://jinyuliao.github.io/blog/html/_images/clone_plugin.png"/>
</div>
<div class="section" id="step-3">
<h2>Step 3</h2>
<p>In your editor, click “File-&gt;New C++ Class”.</p>
<img alt="../../../_images/new_cpp.png" src="https://jinyuliao.github.io/blog/html/_images/new_cpp.png"/>
<p>Click “Next”.</p>
<a class="" data-lightbox="group-9df2b352-02b6-400f-b6f6-955c33c8084d" href="https://jinyuliao.github.io/blog/html/_images/class_wizard_011.png" title="" data-title=""><img src="https://jinyuliao.github.io/blog/html/_images/class_wizard_011.png" class="" width="100%" height="auto" alt=""/>
                </a><p>Set the class name to “Placeholder”</p>
<a class="" data-lightbox="group-44cabd2c-47db-4c3c-abf0-2ff60195874f" href="https://jinyuliao.github.io/blog/html/_images/class_wizard_021.png" title="" data-title=""><img src="https://jinyuliao.github.io/blog/html/_images/class_wizard_021.png" class="" width="100%" height="auto" alt=""/>
                </a><p>Click “Create Class”.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Now we have created a c++ class: Placeholder, as the name implies, it’s a placeholder, we don’t need it anymore, we just need a c++ class to generate a c++ project.</p>
</div>
<p>Right click your “YourProject.uproject” file, click “Generate Visual Studio project files”.</p>
<img alt="../../../_images/generate_project.png" src="https://jinyuliao.github.io/blog/html/_images/generate_project.png"/>
<p>Open YourPorject.sln file, you should see the GenericGraph plugin’s files now.</p>
<img alt="../../../_images/sln.png" src="https://jinyuliao.github.io/blog/html/_images/sln.png"/>
<p><strong>Close your project editor</strong>, then compile the c++ solution(F7).</p>
</div>
<div class="section" id="step-4">
<h2>Step 4</h2>
<p>If compile succeeded, open your editor again, right click in your content browser, you can create GenericGraph asset now.</p>
<a class="" data-lightbox="group-d2f8d879-d25b-479a-a390-df7b6b41fad2" href="https://jinyuliao.github.io/blog/html/_images/generic_graph_asset1.png" title="" data-title=""><img src="https://jinyuliao.github.io/blog/html/_images/generic_graph_asset1.png" class="" width="100%" height="auto" alt=""/>
                </a></div>
<div class="section" id="done">
<h2>Done</h2>
<p>That’s all in this part, you have created a project and compiled the GenericGraph plugin, we will add a “DialogueSession” asset in the next part, then say goodbye to c++ and dive into blueprint.</p>
<p><a class="reference external" href="https://jinyuliao.github.io/blog/html/2017/12/15/ue4_dialogue_system_part2.html">Part2</a></p>
</div>
]]></description>
            <category><![CDATA[ UE4 Dialogue System ]]></category>
             <pubDate>Fri, 15 Dec 2017 00:00:00 +0800</pubDate>
        </item>
    
        <item>
            <link>https://jinyuliao.github.io/blog/html/2017/11/23/srpg_tutorial_pt1_cn.html</link>
            <guid>https://jinyuliao.github.io/blog/html/2017/11/23/srpg_tutorial_pt1_cn.html</guid>
            <title><![CDATA[使用UE4制作SRPG Part1]]></title>
            <description><![CDATA[<h1>使用UE4制作SRPG Part1</h1>
<p>本文不是手把手UE4入门教程，你需要了解UE4的基本运作机制：</p>
<ul class="simple">
<li>了解UE4的GameMode，PlayerController，AIController，Character，Actor，Object</li>
<li>了解UE4的接口(Interface)</li>
<li>能够编写blueprint代码</li>
<li>C++不是必须，虽然本文所提供的样例工程是由C++和blueprint混合编写，但大部分功能blueprint都能实现</li>
</ul>
<p>项目地址： <a class="reference external" href="https://github.com/jinyuliao/SRPGTemplate">SRPGTemplate</a></p>
<div class="section" id="controllertask">
<h2>Controller与Task</h2>
<p>我们定义三个Controller类：</p>
<ul class="simple">
<li>SRPGAIController：继承自AIController，用来接收指令，执行特定操作</li>
<li>SRPGAICommander：继承自AIController，代表真正意义上的AI</li>
<li>SRPGPlayerController：继承自PlayerController，代表玩家</li>
</ul>
<p>SRPGTask代表Character可以执行的任务，比如：</p>
<ul class="simple">
<li>移动到点A</li>
<li>攻击敌人B</li>
<li>移动到点C，然后拾取某个物品</li>
</ul>
<p>所有Character都由SRPGAIController控制，Player或者AICommander无法直接控制Character，需要通过为SRPGAIController分配Task来执行 <strong>移动</strong>， <strong>攻击</strong> 等操作。</p>
<p>示例：</p>
<a class="" data-lightbox="group-5131c1a3-d3e9-45d2-ac52-0c9c1edb2fac" href="https://jinyuliao.github.io/blog/html/_images/controller1.png" title="" data-title=""><img src="https://jinyuliao.github.io/blog/html/_images/controller1.png" class="" width="100%" height="auto" alt=""/>
                </a><p>这样设计能让逻辑更加清晰易懂，以及让某些功能实现起来更加容易。<a class="footnote-reference" href="#f1" id="id1">[1]</a></p>
</div>
<div class="section" id="id2">
<h2>回合制</h2>
<p>定义一个TBPlayer(Turn-based player)接口，SRPGPlayerController、SRPGAICommander都实现此接口。</p>
<p>GameMode维护一个TBPlayer队列，在游戏开始时收集/构造所有的TBPlayer并加入队列。 <a class="footnote-reference" href="#f2" id="id3">[2]</a></p>
<p>TBPlayer中定义一个OnEnterMyTurn函数，GameMode保存了所有的TBPlayer信息，当进入某个Player的回合时，
调用TBPlayer::OnEnterMyTurn通知此此Player进行相关操作(移动、攻击、使用技能和物品)，同时对其他Player和相关Character施加约束：</p>
<ol class="arabic simple">
<li>如果 <strong>其他Player</strong> 是玩家：隐藏某些UI，禁用某些事件 <a class="footnote-reference" href="#f3" id="id4">[3]</a></li>
<li>如果 <strong>其他Player</strong> 是AI：禁止它向SRPGAIController发送指令</li>
<li>对于Character：如果当前Player不是它的操纵着，那么它无法执行任何指令</li>
</ol>
<p>通过施加上述约束，使游戏按回合进行。</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">在战场女武神或者XCom2中，即使不在自己的回合，角色也能做出某些行动，比如攻击视野中移动的敌人，
可以通过修改上述第三条约束，让角色在不是自己回合时做出受限制的行动，这些行动自动触发，无需接收指令</p>
</div>
<p>GameMode提供NextPlayer函数，让Player在执行完相关操作之后结束自己的回合，当所有的Player都完成操作时，游戏的回合数+1。</p>
</div>
<div class="section" id="id5">
<h2>网格</h2>
<p>我的 <a class="reference external" href="https://github.com/jinyuliao/Grid">Grid</a> 插件实现了网格相关的功能，由C++编写，blueprint可以使用、扩展，你也可以选择自己实现。</p>
<p>主要的功能需求如下：</p>
<ul class="simple">
<li>网格查询：根据坐标、中心网格+范围、位置等信息查询相关网格</li>
<li>网格绘制：将网格信息展现给玩家，Grid插件提供贴花(Decal)和轮廓线(Outline, XCom2-like)两种绘制方式</li>
<li>基于网格的寻路(Grid-based pathfinding)：给出起点、终点坐标，返回网格数组</li>
<li>基于网格的运动(Grid-based movement)：让Character沿着网格移动，而不是UE4的默认MoveTo行为(你也可以这么做，XCom2就是例子)</li>
<li>路线绘制：将移动路线展示给玩家，可以使用decal、Particle System或者其他方法，根据游戏需求而定，Grid插件的PathGuide使用UE4的FPrimitiveDrawInterface(PDI)绘制路线，并可以在起点和中点设置不同的贴花(XCom2-like)</li>
</ul>
<p>网格相关的算法 <a class="reference external" href="https://www.redblobgames.com/">RedBlobGames</a> 有很详细的解释，这里就不重复造轮子了。</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">如果你自己实现网格相关功能，并且只用blueprint，网格的绘制最简单的办法可能是贴花(decal)，Blueprint无法访问PDI接口，没办法直接画线，实现网格轮廓线可能比较麻烦，ProceduralMeshComponent+特殊的材质可能是个办法，但我没有验证过。</p>
</div>
</div>
<div class="section" id="ai">
<h2>AI</h2>
<p>AICommander的逻辑如下：</p>
<ol class="arabic simple">
<li>检查是否存在可行动的Character，如果不存在则跳转至7，否则执行2</li>
<li>生成所有可控Character的所有可执行的SRPGTask</li>
<li>评估每个SRPGTask的Utility(Utility的解释见下文)</li>
<li>根据Utility删除明显不合理的SRPGTask</li>
<li>根据Utility随机选择一个SRPGTask，分配给相应的Character并通知其执行</li>
<li>等待SRPGTask执行完成，然后回到1</li>
<li>结束回合</li>
</ol>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Utility是一个[0,1]的浮点数，用来表示SRPGTask的合理度，0表示十分愚蠢的Task，1表示执行此Task可获得胜利，其他Task的Utility位于此之间。
Utility的评估函数直接影响AI的行为，是实现合理AI的关键。</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">上述逻辑保证同一时间AICommander只会让一个Character行动，如果想让多个Character同时行动(在XCom2中，敌人可能三人一队，当发现玩家时，整个小队会同时移动到掩体后面)，可以
修改上述逻辑5，选择多个SRPGTask，分配给相应的Character并通知它们执行</p>
</div>
<div class="section" id="utility">
<h3>Utility评估</h3>
<p>SRPGTask提供一个GetExecuteResult函数，获取Task的执行(预测)结果TaskExecuteResult，包含以下信息：</p>
<ul class="simple">
<li>FinalPostion：执行此Task之后，Character的最终位置</li>
<li>ApplyDamageInfoList：Character能对敌人造成多少伤害</li>
<li>TakeDamageInfoList：Character可能受到多少伤害</li>
<li>ApplyHealingInfoList：Character能治疗多少友军</li>
<li>TakeHealingInfoList：Character能受到多少治疗</li>
</ul>
<p>评估函数获取Task的TaskExecuteResult之后，评估以上信息，返回最终的Utility。</p>
<p>评估函数的实现可以包含sub-utility，比如PositionUtility，DamageUtility，HealingUtility，分别评估位置、伤害和治疗然后再将它们合并成最终的Utility，样例公式如下：</p>
<p><span class="docutils literal"><span class="pre">Utility</span> <span class="pre">=</span> <span class="pre">PositionUtility*PositionWeight</span> <span class="pre">+</span> <span class="pre">DamageUtility*DamageWeight</span> <span class="pre">+</span> <span class="pre">HealingUtility*HealingWeight</span></span></p>
<p>当Character生命值较高时，赋予DamageWeight相对较高的值，使角色倾向于进攻，当Character生命值较低时，赋予PositionWeight和HealingWeight相对较高的值，使角色倾向于逃跑和寻找治疗。</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">sub-utility的计算可以自由设计，值域也可以不受限制，但必须保证最终Utility在[0,1]之间，确保各个SRPGTask之间是可比较的，如果Task1的Utility大于Task2的Utility，那么Task1应该优于Task2。</p>
</div>
<p>Utility评估完成后，AICommander使用以下逻辑选择一个Task执行:</p>
<ul class="simple">
<li>过滤Utility非常低的Task</li>
<li>对于剩下的SRPGTask，求出它们的Utility之和TotalUtility</li>
<li>计算出各个Task被选择的概率 Probability = Utility / TotalUtility</li>
<li>根据计算出来的概率，随机选择一个Task</li>
</ul>
<p>AICommander逻辑示例：</p>
<p>假设我们有5个Task:</p>
<ul class="simple">
<li>T1：移动到点A</li>
<li>T2：移动到点B</li>
<li>T3：移动到点C，拾取道具I</li>
<li>T4：移动到点D，获取治疗</li>
<li>T5：移动到点E，攻击某个敌人</li>
</ul>
<p>AIComander逻辑如下：</p>
<ul class="simple">
<li>评估它们的Utility，分别为U1=0.01, U2=0.1, U3=0.5, U4=0.6, U5=0.8</li>
<li>T1的Utility为0.01实在太低，我们把T1直接排除，剩下T2,T3,T4,T5</li>
<li>求出TotalUtility = 0.1 + 0.5 + 0.6 + 0.8 = 2</li>
<li>算出T2,T3,T4,T5的概率分别为P2 = 0.1/2 = 0.05，P3 = 0.5/2 = 0.25，P4 = 0.6/2 = 0.3，P5 = 0.8/2 = 0.4</li>
<li>从T2,T3,T4,T5中随机选出一个Task执行，选中T2的概率为5%，T3的概率为25%，T4的概率为30%，T5的概率为40%</li>
</ul>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">随机选择一个Task而不是选择最优解是因为如果总是选择最优解会让AI行为可预测，有时还会让玩家的SL大法失效，影响游戏体验。</p>
</div>
<p>关于Utility更详细的介绍可以参考</p>
<p><a class="reference external" href="https://www.amazon.com/Game-AI-Pro-Collected-Professionals/dp/1466565969/ref=sr_1_2?s=books&amp;ie=UTF8&amp;qid=1511454480&amp;sr=1-2">Game AI Pro: Collected Wisdom of Game AI Professionals</a></p>
<blockquote>
<div><p>Chapter 9  An Introduction to Utility Theory</p>
<p>Chapter 10 Building Utility Decisions into Your Existing Behavior Tree</p>
</div></blockquote>
<p><a class="reference external" href="https://www.amazon.com/Game-AI-Pro-Collected-Professionals/dp/1482254794/ref=sr_1_3?s=books&amp;ie=UTF8&amp;qid=1511454480&amp;sr=1-3">Game AI Pro 2: Collected Wisdom of Game AI Professionals</a></p>
<blockquote>
<div>Chapter 3 Dual-Utility Reasoning</div></blockquote>
</div>
</div>
<div class="section" id="id6">
<h2>伤害计算</h2>
<p>定义一个类SRPGCalculator和一系列DataModifier接口，用于数值计算。</p>
<p>特定DataModifier用来修改对应的某项数据，比如ModifierDamage修改伤害量，ModifierHealing修改治疗量。</p>
<p>技能、装备、Buff/Debuff都可以实现DataModifier接口，Character提供函数返回指定类型的所有的DataModifier供SRPGCalculator使用。</p>
<p>伤害计算流程如下：</p>
<ol class="arabic simple">
<li>Character发起请求对某个Actor造成伤害，并向Calculator提供相应的信息：目标(Target), 基础伤害(BaseDamage)，基础命中率(BaseHitRate)，基础暴击率(BaseCriticalRate)，额外信息(DamageFlag)</li>
<li>Calculator获取发起者的所有ModifierHitRate接口(如果存在)，修改命中率</li>
<li>Calculator获取目标Actor的所有ModifierHitRate接口(如果存在)，计算出最终命中率</li>
<li>以类似2、3的步骤计算最终暴击率</li>
<li>使用随机数判断是否命中、暴击</li>
<li>如果命中，以类似2、3的步骤计算最终伤害值</li>
<li>如果暴击，在步骤6的结果上加上暴击伤害加成</li>
<li>如果最终伤害值大于0，使用此数值对目标造成伤害</li>
</ol>
<p>流程图如下：</p>
<a class="" data-lightbox="group-586ed617-c3f0-4e2a-bbb2-c63df3106a58" href="https://jinyuliao.github.io/blog/html/_images/damage_calculation1.png" title="" data-title=""><img src="https://jinyuliao.github.io/blog/html/_images/damage_calculation1.png" class="" width="100%" height="auto" alt=""/>
                </a><table class="docutils footnote" frame="void" id="f1" rules="none">
<colgroup><col class="label"/><col/></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id1">[1]</a></td><td>这个设计应该也适用于RTS，需要注意每个Controller都是一个Actor，当Character特别多时，慎用’GetAllActorsOfClass’。</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="f2" rules="none">
<colgroup><col class="label"/><col/></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id3">[2]</a></td><td>大部分情况下只有两个TBPlayer，玩家和AI，如果存在玩家不可操作的友军，那么会出现第三个Player，三个以上比较少见。</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="f3" rules="none">
<colgroup><col class="label"/><col/></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id4">[3]</a></td><td>比如隐藏 <strong>下一回合</strong> 按钮，禁止选中角色等</td></tr>
</tbody>
</table>
</div>
]]></description>
            <category><![CDATA[ UE4 SRPG ]]></category>
             <pubDate>Thu, 23 Nov 2017 00:00:00 +0800</pubDate>
        </item>
    
    </channel>
</rss>